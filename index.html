<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализ интенсивности звука с коррекцией фона</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/addons/p5.sound.min.js"></script>
    <style>
        body { 
            background-color: #808080;
            font-family: Arial, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: white; 
        }
        button { 
            padding: 10px 20px; 
            font-size: 16px; 
            cursor: pointer; 
            margin: 10px; 
        }
        canvas { 
            border: 1px solid white; 
        }
        .error { 
            color: red; 
            font-weight: bold; 
        }
    </style>
</head>
<body>
    <h1>Анализ интенсивности звука с коррекцией фона</h1>
    <div>
        <p><strong>Как использовать:</strong> Нажмите кнопку "Начать запись", разрешите доступ к микрофону. 
        После 15 секунд записи вы увидите график, где:</p>
        <ul>
            <li><span style="color: #FF0000;">Красная линия</span> - очищенный сигнал</li>
            <li><span style="color: #00FF00;">Зелёная линия</span> - фоновый шум</li>
            <li><span style="color: #0000FF;">Синяя линия</span> - интегральная кривая</li>
        </ul>
    </div>
    <button id="recordButton">Начать запись (15 сек)</button>
    <p id="status">Готов к записи</p>
    <p id="error" class="error"></p>
    <h2>График интенсивности звука</h2>
    <div id="canvasContainer"></div>

    <script>
        let mic, recorder, soundFile;
        let state = 0;
        let amplitudeData = [];
        let backgroundNoise = [];
        let cleanSignal = [];
        let integralSignal = [];
        let recordButton, statusText, errorText;

        // Проверка загрузки p5.js и p5.sound.js
        window.onload = function() {
            if (typeof p5 === 'undefined' || typeof p5.SoundRecorder === 'undefined') {
                document.getElementById('error').innerHTML = 'Ошибка: Не удалось загрузить библиотеки p5.js или p5.sound.js';
                return;
            }
            // Инициализация элементов DOM
            recordButton = document.getElementById('recordButton');
            statusText = document.getElementById('status');
            errorText = document.getElementById('error');
            setup();
        };

        function setup() {
            try {
                let canvas = createCanvas(800, 400);
                canvas.parent('canvasContainer');
                background(0);
                mic = new p5.AudioIn();
                recorder = new p5.SoundRecorder();
                recorder.setInput(mic);
                soundFile = new p5.SoundFile();
                recordButton.addEventListener('click', toggleRecording);
            } catch (e) {
                errorText.innerHTML = 'Ошибка инициализации: ' + e.message;
            }
        }

        function toggleRecording() {
            try {
                if (state === 0) {
                    mic.start(() => {
                        recorder.record(soundFile);
                        state = 1;
                        statusText.innerHTML = 'Идёт запись...';
                        setTimeout(stopRecording, 15000);
                    }, (err) => {
                        errorText.innerHTML = 'Ошибка доступа к микрофону: ' + err.message;
                    });
                }
            } catch (e) {
                errorText.innerHTML = 'Ошибка при записи: ' + e.message;
            }
        }

        function stopRecording() {
            try {
                if (state === 1) {
                    mic.stop();
                    recorder.stop();
                    state = 2;
                    statusText.innerHTML = 'Запись завершена, обработка данных...';
                    processAudio();
                }
            } catch (e) {
                errorText.innerHTML = 'Ошибка при остановке записи: ' + e.message;
            }
        }

        function processAudio() {
            try {
                let samples = soundFile.getPeaks(800);
                amplitudeData = samples.map(Math.abs);
                backgroundNoise = new Array(800).fill(0.05);
                cleanSignal = amplitudeData.map((val, i) => Math.max(0, val - backgroundNoise[i]));
                integralSignal = new Array(800).fill(0);
                let sum = 0;
                for (let i = 0; i < cleanSignal.length; i++) {
                    sum += cleanSignal[i];
                    integralSignal[i] = sum;
                }
                statusText.innerHTML = 'График готов';
                state = 3;
            } catch (e) {
                errorText.innerHTML = 'Ошибка обработки аудио: ' + e.message;
            }
        }

        function draw() {
            if (state === 3) {
                background(0);
                noFill();
                strokeWeight(2);

                // Красная линия - очищенный сигнал
                stroke(255, 0, 0);
                beginShape();
                for (let i = 0; i < cleanSignal.length; i++) {
                    vertex(i, height - cleanSignal[i] * height * 0.5);
                }
                endShape();

                // Зелёная линия - фоновый шум
                stroke(0, 255, 0);
                beginShape();
                for (let i = 0; i < backgroundNoise.length; i++) {
                    vertex(i, height - backgroundNoise[i] * height * 0.5);
                }
                endShape();

                // Синяя линия - интегральная кривая
                stroke(0, 0, 255);
                beginShape();
                for (let i = 0; i < integralSignal.length; i++) {
                    vertex(i, height - (integralSignal[i] / Math.max(...integralSignal)) * height * 0.5);
                }
                endShape();
            }
        }
    </script>
</body>
</html>