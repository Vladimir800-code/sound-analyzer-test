<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∑–≤—É–∫–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: linear-gradient(to bottom, #f0f4f8, #dbeafe);
            margin: 0;
            padding: 0;
        }
        h1 {
            margin-top: 20px;
            color: #1e3a8a;
        }
        p {
            color: #333;
        }
        button {
            padding: 10px 20px;
            font-size: 18px;
            background-color: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s ease;
        }
        button:hover {
            background-color: #1e40af;
        }
        button:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
        }
        canvas {
            border: 1px solid #000;
            background: white;
            margin-top: 20px;
        }
        #status {
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>–ê–Ω–∞–ª–∏–∑ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –∑–≤—É–∫–∞</h1>
    <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å 10 —Å–µ–∫—É–Ω–¥ –∑–≤—É–∫–∞ –∏ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏.</p>
    <button id="startBtn">üéô –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
    <p id="status"></p>
    <canvas id="graph" width="800" height="400"></canvas>

    <script>
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const canvas = document.getElementById('graph');
        const ctx = canvas.getContext('2d');

        const DURATION = 10; // —Å–µ–∫—É–Ω–¥
        const CHUNK_SIZE = 1024;

        let audioContext;
        let scriptProcessor;
        let audioData = [];

        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–µ–∑ HTTPS
        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
            status.textContent = '‚ö† –ó–∞–ø—É—Å—Ç–∏—Ç–µ —á–µ—Ä–µ–∑ HTTPS –∏–ª–∏ GitHub Pages –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º.';
            startBtn.disabled = true;
            throw new Error('Use HTTPS or localhost for microphone access.');
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ API
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            status.textContent = '‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º.';
            startBtn.disabled = true;
        }

        startBtn.addEventListener('click', async () => {
            try {
                status.textContent = 'üîç –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...';
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                await audioContext.resume();

                const source = audioContext.createMediaStreamSource(stream);
                scriptProcessor = audioContext.createScriptProcessor(CHUNK_SIZE, 1, 1);

                audioData = [];
                scriptProcessor.onaudioprocess = (event) => {
                    const input = event.inputBuffer.getChannelData(0);
                    audioData.push(...input);
                };

                source.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);

                startBtn.disabled = true;
                status.textContent = 'üé§ –ò–¥—ë—Ç –∑–∞–ø–∏—Å—å...';

                setTimeout(() => {
                    scriptProcessor.disconnect();
                    source.disconnect();
                    stream.getTracks().forEach(track => track.stop());
                    audioContext.close();
                    status.textContent = 'üìä –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
                    processAudio();
                }, DURATION * 1000);

            } catch (err) {
                status.textContent = `–û—à–∏–±–∫–∞: ${err.message}`;
                console.error(err);
            }
        });

        function processAudio() {
            if (audioData.length === 0) {
                status.textContent = '‚ùå –ó–≤—É–∫ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω.';
                startBtn.disabled = false;
                return;
            }

            const rms = [];
            for (let i = 0; i < audioData.length; i += CHUNK_SIZE) {
                let sum = 0;
                const chunk = audioData.slice(i, i + CHUNK_SIZE);
                for (let j = 0; j < chunk.length; j++) {
                    sum += chunk[j] ** 2;
                }
                rms.push(Math.sqrt(sum / chunk.length));
            }

            drawGraph(rms);
            status.textContent = '‚úÖ –ì—Ä–∞—Ñ–∏–∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω!';
            startBtn.disabled = false;
        }

        function drawGraph(rms) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();

            const maxRms = Math.max(...rms, 0.001);
            rms.forEach((value, index) => {
                const x = (canvas.width / rms.length) * index;
                const y = canvas.height - (value / maxRms) * canvas.height * 0.9;
                if (index === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.strokeStyle = '#2563eb';
            ctx.lineWidth = 2;
            ctx.stroke();

            // –û—Å–∏
            ctx.beginPath();
            ctx.moveTo(0, canvas.height);
            ctx.lineTo(canvas.width, canvas.height);
            ctx.moveTo(0, 0);
            ctx.lineTo(0, canvas.height);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1;
            ctx.stroke();

            // –ü–æ–¥–ø–∏—Å–∏
            ctx.font = '14px Arial';
            ctx.fillStyle = '#000';
            ctx.fillText('–í—Ä–µ–º—è', canvas.width / 2 - 20, canvas.height - 5);
            ctx.save();
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å (RMS)', -canvas.height / 2 - 40, 15);
            ctx.restore();
        }
    </script>
</body>
</html>
