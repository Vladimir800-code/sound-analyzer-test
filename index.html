<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–Ω–∞–ª–∏–∑ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –∑–≤—É–∫–∞</title>
    <style>
        body { 
            font-family: 'Segoe UI', Roboto, Arial, sans-serif; 
            text-align: center; 
            background: #f9fafb;
            margin: 0; padding: 0;
        }
        header {
            background: linear-gradient(135deg, #dbeafe, #eff6ff);
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        h1 { margin: 0; color: #1e3a8a; }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 15px;
            border: none;
            border-radius: 10px;
            background: #2563eb;
            color: white;
            cursor: pointer;
            transition: background 0.3s, transform 0.1s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        button:hover { background: #1e40af; }
        button:active { transform: scale(0.97); }
        button:disabled { background: #94a3b8; cursor: not-allowed; }
        #status { font-weight: bold; margin: 10px; }
        #status.recording { animation: blink 1s infinite; color: red; }
        @keyframes blink { 50% { opacity: 0; } }
        #graph-title { font-weight: bold; color: #111827; font-size: 18px; margin-top: 10px; display: none; }
        canvas { 
            border: 1px solid #cbd5e1; 
            margin-top: 20px; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body>
    <header>
        <h1>–ê–Ω–∞–ª–∏–∑ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –∑–≤—É–∫–∞</h1>
        <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø–∏—Å–∏ 15 —Å–µ–∫—É–Ω–¥ –∑–≤—É–∫–∞.</p>
        <button id="startBtn">üéô –ó–∞–ø–∏—Å–∞—Ç—å</button>
        <p id="status"></p>
    </header>
    <main>
        <p id="graph-title">–ì—Ä–∞—Ñ–∏–∫ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏</p>
        <canvas id="graph" width="800" height="400"></canvas>
    </main>

    <script>
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const graphTitle = document.getElementById('graph-title');
        const canvas = document.getElementById('graph');
        const ctx = canvas.getContext('2d');
        const DURATION = 15;
        const SAMPLE_RATE = 44100;
        const CHUNK_SIZE = 1024;
        let audioContext;
        let scriptProcessor;
        let audioData = [];

        startBtn.addEventListener('click', async () => {
            try {
                status.textContent = '–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...';
                const stream = await navigator.mediaDevices.getUserMedia({ audio: { sampleRate: SAMPLE_RATE } });
                audioContext = new AudioContext({ sampleRate: SAMPLE_RATE });
                const source = audioContext.createMediaStreamSource(stream);
                scriptProcessor = audioContext.createScriptProcessor(CHUNK_SIZE, 1, 1);

                scriptProcessor.onaudioprocess = (event) => {
                    const input = event.inputBuffer.getChannelData(0).slice();
                    audioData.push(...input);
                };

                source.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);
                startBtn.disabled = true;
                status.classList.add('recording');
                status.textContent = 'üé§ –ó–∞–ø–∏—Å—å...';

                setTimeout(() => {
                    scriptProcessor.disconnect();
                    source.disconnect();
                    stream.getTracks().forEach(track => track.stop());
                    audioContext.close();
                    status.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
                    status.classList.remove('recording');
                    processAudio();
                }, DURATION * 1000);
            } catch (err) {
                status.textContent = `–û—à–∏–±–∫–∞: ${err.message}. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω —Ä–∞–∑—Ä–µ—à–µ–Ω –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è HTTPS –∏–ª–∏ localhost.`;
                status.classList.remove('recording');
                console.error('Error:', err);
                startBtn.disabled = false;
            }
        });

        function processAudio() {
            if (audioData.length === 0) {
                status.textContent = '–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –∑–≤—É–∫–∞ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω—ã';
                startBtn.disabled = false;
                return;
            }

            const rms = [];
            for (let i = 0; i < audioData.length; i += CHUNK_SIZE) {
                let sum = 0;
                const chunk = audioData.slice(i, i + CHUNK_SIZE);
                for (let j = 0; j < chunk.length; j++) {
                    sum += chunk[j] ** 2;
                }
                rms.push(Math.sqrt(sum / chunk.length));
            }

            const integral = [];
            let cumulativeSum = 0;
            for (let i = 0; i < rms.length; i++) {
                cumulativeSum += rms[i];
                integral.push(cumulativeSum);
            }
            const maxIntegral = Math.max(...integral, 0.001);
            let normalizedIntegral = integral.map(val => val / maxIntegral);

            // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –Ω–∞–∫–ª–æ–Ω—É (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
            const timeStep = DURATION / rms.length;
            let constrained = [normalizedIntegral[0]];
            let flatSegments = [];
            for (let i = 1; i < normalizedIntegral.length; i++) {
                const slope = (normalizedIntegral[i] - constrained[i-1]) / timeStep;
                if (slope > 0.15) {
                    constrained.push(constrained[i-1]); // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫
                    flatSegments.push(i); // –æ—Ç–º–µ—á–∞–µ–º –∏–Ω–¥–µ–∫—Å —Å—Ä–µ–∑–∞
                } else {
                    constrained.push(normalizedIntegral[i]);
                }
            }

            // –ø–µ—Ä–µ—Å—á—ë—Ç –Ω–æ—Ä–º–∏—Ä–æ–≤–∫–∏
            const maxVal = Math.max(...constrained, 0.001);
            constrained = constrained.map(v => v / maxVal);

            drawGraph(constrained, timeStep, flatSegments);
            status.textContent = '‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
            graphTitle.style.display = 'block';
            startBtn.disabled = false;
        }

        function drawGraph(data, timeStep, flatSegments) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // —Å–µ—Ç–∫–∞
            ctx.beginPath();
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= 1; i += 0.1) {
                const y = canvas.height - i * canvas.height;
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
            }
            for (let i = 0; i <= DURATION; i += 1) {
                const x = (i / DURATION) * canvas.width;
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
            }
            ctx.stroke();

            // –≥—Ä–∞—Ñ–∏–∫ (–æ–±—ã—á–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏)
            ctx.beginPath();
            ctx.strokeStyle = '#2563eb';
            ctx.lineWidth = 2;
            for (let i = 0; i < data.length; i++) {
                const x = (canvas.width / data.length) * i;
                const y = canvas.height - data[i] * canvas.height;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // –∫—Ä–∞—Å–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏ (—Å—Ä–µ–∑–∞–Ω–Ω—ã–µ)
            ctx.beginPath();
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            flatSegments.forEach(i => {
                const x1 = (canvas.width / data.length) * (i-1);
                const y1 = canvas.height - data[i-1] * canvas.height;
                const x2 = (canvas.width / data.length) * i;
                const y2 = canvas.height - data[i] * canvas.height;
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
            });
            ctx.stroke();

            // –æ—Å–∏
            ctx.beginPath();
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 1;
            ctx.moveTo(0, canvas.height);
            ctx.lineTo(canvas.width, canvas.height);
            ctx.moveTo(0, 0);
            ctx.lineTo(0, canvas.height);
            ctx.stroke();

            // –ø–æ–¥–ø–∏—Å–∏
            ctx.font = '12px Segoe UI';
            ctx.fillStyle = '#111827';
            for (let i = 0; i <= DURATION; i += 1) {
                const x = (i / DURATION) * canvas.width;
                ctx.fillText(i, x - 5, canvas.height - 5);
            }
            for (let i = 0; i <= 1; i += 0.1) {
                const y = canvas.height - i * canvas.height;
                ctx.fillText(i.toFixed(1), 5, y + 5);
            }

            ctx.fillText('–í—Ä–µ–º—è (—Å)', canvas.width / 2, canvas.height - 10);
            ctx.save();
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('–ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å', -canvas.height / 2, 15);
            ctx.restore();
        }
    </script>
</body>
</html>